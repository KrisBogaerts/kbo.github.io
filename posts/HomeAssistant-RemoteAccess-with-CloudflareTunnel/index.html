<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Home Assistant remote access with CloudFlare Tunnel" /><meta name="author" content="Kris Bogaerts" /><meta property="og:locale" content="en" /><meta name="description" content="Cloudflare Tunnel" /><meta property="og:description" content="Cloudflare Tunnel" /><link rel="canonical" href="https://krisbogaerts.github.io/posts/HomeAssistant-RemoteAccess-with-CloudflareTunnel/" /><meta property="og:url" content="https://krisbogaerts.github.io/posts/HomeAssistant-RemoteAccess-with-CloudflareTunnel/" /><meta property="og:site_name" content="Tech Notes" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-29T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Home Assistant remote access with CloudFlare Tunnel" /><meta name="twitter:site" content="@BogaertsKris" /><meta name="twitter:creator" content="@Kris Bogaerts" /><meta name="google-site-verification" content="Bqm1xBElDQYV4UH_5yofjQvnHdEITNr58MntJSYMMMI" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Kris Bogaerts"},"dateModified":"2022-09-01T08:41:49+02:00","datePublished":"2022-08-29T00:00:00+02:00","description":"Cloudflare Tunnel","headline":"Home Assistant remote access with CloudFlare Tunnel","mainEntityOfPage":{"@type":"WebPage","@id":"https://krisbogaerts.github.io/posts/HomeAssistant-RemoteAccess-with-CloudflareTunnel/"},"url":"https://krisbogaerts.github.io/posts/HomeAssistant-RemoteAccess-with-CloudflareTunnel/"}</script><title>Home Assistant remote access with CloudFlare Tunnel | Tech Notes</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tech Notes"><meta name="application-name" content="Tech Notes"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7308669807791841" crossorigin="anonymous"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://media-exp1.licdn.com/dms/image/C5603AQELKDvai-z10A/profile-displayphoto-shrink_200_200/0/1633932732690?e=1666828800&v=beta&t=Ro_IDU6cQJuIgWaZrtKoXYIR3pDmRw_yYi1BWfzRN8Y" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tech Notes</a></div><div class="site-subtitle font-italic">Defensive (Cyber) Security & Smart Home</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/KrisBogaerts" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/BogaertsKris" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Home Assistant remote access with CloudFlare Tunnel</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Home Assistant remote access with CloudFlare Tunnel</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1661724000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 29, 2022 </em> </span> <span> Updated <em class="" data-ts="1662014509" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 1, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> Kris Bogaerts </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1709 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><h1 id="cloudflare-tunnel">Cloudflare Tunnel</h1><p>Cloudflare Tunnel provides you with a secure way to connect your resources to Cloudflare without a publicly routable IP address. With Tunnel, you do not send traffic to an external IP — instead, a lightweight daemon in your infrastructure (cloudflared) creates outbound-only connections to Cloudflare’s edge. Cloudflare Tunnel can connect HTTP web servers, SSH servers, remote desktops, and other protocols safely to Cloudflare. This way, your origins can serve traffic through Cloudflare without being vulnerable to attacks that bypass Cloudflare.</p><h2 id="how-it-works"><span class="mr-2">How it works</span><a href="#how-it-works" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Cloudflared establishes outbound connections (tunnels) between your resources and the Cloudflare edge. Tunnels are persistent objects that route traffic to DNS records. Within the same tunnel, you can run as many cloudflared processes (connectors) as needed. These processes will establish connections to the Cloudflare edge and send traffic to the nearest Cloudflare data center.</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://developers.cloudflare.com/cloudflare-one/static/documentation/connections/connect-apps/handshake.jpg" alt="A screenshot" width="700" height="400" data-proofer-ignore></p><h1 id="home-assistant-add-on-cloudflared">Home Assistant Add-on: Cloudflared</h1><blockquote class="prompt-warning"><div><p>Publishing Home Assistant directly on the internet is not without any risk. This technical note helps with the configuration and several security measures, but use this configuration or the Cloudflare Tunnel at your own risk. Using https://www.nabucasa.com/ or Home Assistant cloud is recommended.</p></div></blockquote><p>Cloudflared connects your Home Assistant instance via a secure tunnel to a domain or subdomain at Cloudflare. It exposes your Home Assistant to the Internet without opening ports on your router. Additionally, you can utilize Cloudflare Teams, their Zero Trust platform, to further secure your Home Assistant connection.</p><p>To use this add-on, you have to own a domain name (e.g. example.com) and use the DNS servers of Cloudflare. If you do not have one, you can get one for free at Freenom.</p><blockquote><p>Please make sure to be compliant with the <a href="https://www.cloudflare.com/terms/">Cloudflare Self-Serve Subscription Agreement</a> when using this add-on. Especially section 2.8 could be breached when mainly streaming videos or other non-HTML content.</p></blockquote><p><a href="https://github.com/brenner-tobias/addon-cloudflared/blob/main/cloudflared/DOCS.md">Read the full add-on documentation</a></p><h2 id="installation"><span class="mr-2">Installation</span><a href="#installation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote><p><strong>Prerequisites</strong></p><ul><li>Make sure to remove all other add-ons or configuration entries handling SSL certificates. That means if you already have the DuckDNS add-on, Let’s Encrypt add-on, or something similar, or you have manually configured some SSL certificates in your Home Assistant, you have to remove them.<li>You have to have a working Cloudflare setup with a domain name, and we already have that, so we are good to go.<li>And the last prerequisite is to decide whether to use a local or managed tunnel (We are going to use a local one)</ul></blockquote><p>To install this add-on, manually add the HA-Addons repository link https://github.com/brenner-tobias/ha-addons to Home Assistant.</p><ol><li><p>Go to Settings, Add-ons, and Add-on Store.</p><li><p>Select repositories from the upper right menu. <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="/assets/img/Screenshot%20at%20Aug%2029%2014-05-42_ha-repo.png" alt="Ha add-on repo" width="700" height="400" data-proofer-ignore></p><li><p>Add https://github.com/brenner-tobias/ha-addons <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="/assets/img/Screenshot%20at%20Aug%2029%2014-05-42_ha-repo2.png" alt="Ha add-on repo add" width="700" height="400" data-proofer-ignore></p><li><p>Select the Cloudflared addon from the list and click install.</p><li><p>Go to the add-on configuration and provide you external hostname and Cloudflare tunnel name. <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="/assets/img/Screenshot%20at%20Aug%2029%2014-05-42_ha-cloudflaredconfig.png" alt="Cloudflared Config" width="700" height="400" data-proofer-ignore></p><li>Enable IP banning and the x-forwarded-fore header use in Home Assistant.<blockquote><p>This will enable IP banning after 5 failed logging attempts and the processing of the original web client IP address via the x-forwarded-for header in Home Assistant.</p></blockquote><p>Paste the following lines inside the configuration.yaml and save.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="na">http</span><span class="pi">:</span>
  <span class="na">ip_ban_enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">login_attempts_threshold</span><span class="pi">:</span> <span class="m">5</span>
  <span class="na">use_x_forwarded_for</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">trusted_proxies</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">172.30.33.0/24</span>
</pre></table></code></div></div><li><p>Restart Home Assistant.</p><li>Do not start the add-on yet.</ol><h1 id="securing-access-to-the-cloudflare-account">Securing Access to the Cloudflare Account</h1><blockquote><p>The add-on downloads, after authentication, a cert.pem file to authenticate your instance of Cloudflare against your Cloudflare account. You can not revoke access to this file from your cloudflare account! https://github.com/cloudflare/cloudflared/issues/93</p></blockquote><h2 id="work-around"><span class="mr-2">Work Around</span><a href="#work-around" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ol><li>Create a new (secondary) Cloudflare account and invite it to yourCloudflare (primary) account that manages your domain (https://dash.cloudflare.com/sign-up)<li>Cloudflare Dashboard-&gt; Manage Account-&gt; Members-&gt; Invite Member<li>Instead of using your primary account to authenticate the tunnel, use your secondary account.</ol><blockquote><p>If your cert.pem file is compromised, you can revoke your secondary account from your primary account.</p></blockquote><h1 id="connection">Connection</h1><ol><li><p>Start the Cloudflared add-on<br /> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="/assets/img/Screenshot%20at%20Aug%2029%2014-05-42_startcloudflared.png" alt="Cloudflared Config" width="700" height="400" data-proofer-ignore></p><li>Check the logs of the “Cloudflare” add-on. You need to copy a URL from the logs and visit it to authenticate.<blockquote><p>Make sure to use the secondary account for authentication and select the primary account for tunnel creation and validation!</p></blockquote><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="/assets/img/Screenshot%20at%20Aug%2029%2014-05-42_ha-cloudflaredlogs.png" alt="Cloudflared Log Invite" width="700" height="400" data-proofer-ignore></p><li>Check the add-on logs for<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="go">[15:11:13] INFO: Finished setting-up the Cloudflare tunnel
s6-rc: info: service init-cloudflared-config successfully started
s6-rc: info: service cloudflared: starting
s6-rc: info: service cloudflared successfully started
s6-rc: info: service healthcheck: starting
s6-rc: info: service healthcheck successfully started
s6-rc: info: service legacy-services: starting
s6-rc: info: service legacy-services successfully started
[15:11:13] INFO: Starting Cloudflared Healthcheck for Home-Assistant add-on.
[15:11:14] INFO: Connecting Cloudflared Tunnel..
</span></pre></table></code></div></div></ol><h1 id="additional-security">Additional Security</h1><h2 id="cloudflare"><span class="mr-2">Cloudflare</span><a href="#cloudflare" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>By using Cloudflare (as a proxy), we can add additional security to the connection.</p><h3 id="only-allow-traffic-on-http-and-https-on-the-cloudflare-edge-for-home-assistant"><span class="mr-2">Only allow traffic on HTTP and HTTPS on the Cloudflare edge for Home Assistant</span><a href="#only-allow-traffic-on-http-and-https-on-the-cloudflare-edge-for-home-assistant" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>The connection itself, other ports 80 and 443, will not work, but it is better to block all other ports on the CloudFlare edge.</p></blockquote><ol><li>Open the Cloudflare dashboard and go to your website e.g. domain and select Security and then WAF in the left pane.<li>Create a firewall rule with the following expression (edit expression or use the expression builder if you prefer that).<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">http.host eq "ha.yourdomain.com" and not cf.edge.server_port in {80 443}
</span></pre></table></code></div></div><li>Choose action Block and deploy firewall rule</ol><h3 id="only-allow-traffic-from-specific-countries-for-me-belgium-and-the-netherlands-is-sufficient"><span class="mr-2">Only allow traffic from specific countries (for me, Belgium and the Netherlands is sufficient).</span><a href="#only-allow-traffic-from-specific-countries-for-me-belgium-and-the-netherlands-is-sufficient" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>This will also prevent global scanning and reconnaissance and list your home assistant url</p></blockquote><ol><li>Open the Cloudflare dashboard and go to your website, e.g. domain, and select Security and then WAF in the left pane<li>Create a firewall rule with the following expression (edit expression or use the expression builder if you prefer that)<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">(http.host in {"ha.yourdomain.com"} and not ip.geoip.country in {"NL" "BE"})
</span></pre></table></code></div></div><li>Choose action Block and deploy firewall rule</ol><h3 id="deny-access-from-the-internet-to-the-home-assistant-local-uri"><span class="mr-2">Deny access from the internet to the Home Assistant /local URI</span><a href="#deny-access-from-the-internet-to-the-home-assistant-local-uri" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>Files served from the www/local folder, aren’t protected by the Home Assistant authentication. Files stored in this folder, if the URL is known, can be accessed by anybody without authentication. https://github.com/home-assistant/core/issues/31821</p></blockquote><ol><li>Open the Cloudflare dashboard and go to your website, e.g. domain, and select Security and then WAF in the left pane<li>Create a firewall rule with the following expression (edit expression or use the expression builder if you prefer that).<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">(http.host in {"ha.yourdomain.com"} and http.request.uri.path eq "/local")
</span></pre></table></code></div></div><li>Choose action Block and deploy firewall rule</ol><h3 id="redirect-all-http-to-https-and-minimum-tls-version"><span class="mr-2">Redirect all HTTP to HTTPS and minimum TLS version</span><a href="#redirect-all-http-to-https-and-minimum-tls-version" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li>Open the Cloudflare dashboard and go to your website, e.g. domain, select SSL/TLS and then Egd e Certificates in the left pane<ul><li>Enable Always Use HTTPS<li>Select TLS1.2 as the Minimal TLS version.</ul></ol><h3 id="bot-fight-mode"><span class="mr-2">Bot Fight Mode</span><a href="#bot-fight-mode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li>Open the Cloudflare dashboard and go to your website e.g. domain and select Security and then Bots in the left pane<ul><li>Enable Bot Fight Mode<blockquote><p>this could break something as it injects javascript to match patterns of known bots. For me, everything is working fine.</p></blockquote></ul></ol><p><strong><em>Do not forget to secure your primary and secondary Cloudflare accounts with Multi-Factor authentication</em></strong></p><h2 id="home-assistant"><span class="mr-2">Home Assistant</span><a href="#home-assistant" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h2 id="secure-your-home-assistant-login-with-multi-factor-authentication"><span class="mr-2">Secure your Home Assistant login with multi-factor authentication.</span><a href="#secure-your-home-assistant-login-with-multi-factor-authentication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://www.home-assistant.io/docs/authentication/multi-factor-auth/">https://www.home-assistant.io/docs/authentication/multi-factor-auth/</a></p><blockquote><p>By default, the totp module named authenticator app will be autoloaded.</p></blockquote><p>You can turn MFA on and off on the profile page for your user account.</p><h2 id="ip-banning-and-x-forwarded-for"><span class="mr-2">IP banning (and x-forwarded-for)</span><a href="#ip-banning-and-x-forwarded-for" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Previously enabled -&gt; Home Assistant Add-on: Cloudflare -&gt; Installation -&gt; Step 6</p><h2 id="home-assistant-notifications"><span class="mr-2">Home Assistant notifications</span><a href="#home-assistant-notifications" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote><p>Home Assistant provides notifications in the app in the notification center. I prefer to also have a notification on my mobile when there is a failed logon or an IP is banned.</p></blockquote><h3 id="failed-logon-notification"><span class="mr-2">Failed logon notification</span><a href="#failed-logon-notification" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="na">alias</span><span class="pi">:</span> <span class="s">Send notification upon failed login attempt</span>
<span class="na">trigger</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">state</span>
    <span class="na">entity_id</span><span class="pi">:</span> <span class="s">persistent_notification.http_login</span>
<span class="na">condition</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">condition</span><span class="pi">:</span> <span class="s">template</span>
    <span class="na">value_template</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
<span class="na">action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">service</span><span class="pi">:</span> <span class="s">notify.mobile_app</span>
    <span class="na">data_template</span><span class="pi">:</span>
      <span class="na">title</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
      <span class="na">message</span><span class="pi">:</span> <span class="pi">&gt;-</span>
        <span class="s">url: https://whatismyipaddress.com/ip/</span>
</pre></table></code></div></div><h3 id="ip-ban-notification"><span class="mr-2">IP Ban notification</span><a href="#ip-ban-notification" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="na">alias</span><span class="pi">:</span> <span class="s">Send notification upon banned IP</span>
<span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
<span class="na">trigger</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">state</span>
    <span class="na">entity_id</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">persistent_notification.ip_ban</span>
<span class="na">condition</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">condition</span><span class="pi">:</span> <span class="s">template</span>
    <span class="na">value_template</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
<span class="na">action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">service</span><span class="pi">:</span> <span class="s">notify.mobile_app</span>
    <span class="na">data_template</span><span class="pi">:</span>
      <span class="na">title</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
      <span class="na">message</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
<span class="na">mode</span><span class="pi">:</span> <span class="s">single</span>
</pre></table></code></div></div><h1 id="validation">Validation</h1><h2 id="connection-logon-and-multi-factor-authentication"><span class="mr-2">Connection, logon, and Multi-Factor authentication</span><a href="#connection-logon-and-multi-factor-authentication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Open a new browser tab and connect to your external hostname; for example, https://ha.mydomain.com.</p><h2 id="only-allow-traffic-from-specific-countries"><span class="mr-2">Only allow traffic from specific countries.</span><a href="#only-allow-traffic-from-specific-countries" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ol><li>Change the Cloudflare Firewall rule to DE as a country for validation and save<div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="s">(http.host in {"ha.yourdomain.com"} and not ip.geoip.country in {"NL" "DE"})</span>
</pre></table></code></div></div><li><p>Open a new browser tab and connect to your external hostname; for example, https://ha.mydomain.com.</p><p>You should receive Access Denied. <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="/assets/img/Screenshot%20at%20Aug%2030_ha_test1.png" alt="Cloudflared Denied" width="700" height="400" data-proofer-ignore></p><p>Check the logs in Cloudflare -&gt; Security -&gt; Overview. You should see the Action Taken Block with the rule name and extra details. <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="/assets/img/Screenshot%20at%20Aug%2030_ha_test1b.png" alt="Cloudflared Denied" width="700" height="400" data-proofer-ignore></p><li><p>Change the firewall rule back to its original configuration and validate the connection.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">(http.host in {"ha.yourdomain.com"} and not ip.geoip.country in {"NL" "BE"})
</span></pre></table></code></div></div></ol><h3 id="failed-logon-and-notification"><span class="mr-2">Failed logon and notification</span><a href="#failed-logon-and-notification" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li><p>Open a new browser tab and connect to your external hostname; for example https://ha.mydomain.com and use a wrong username and password. This should give you a persistent notification in the notification center in the Home Assistant dashboard and a notification on your mobile or other device that you have configured.</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3C/svg%3E" data-src="/assets/img/Screenshot%20at%20Aug%2030_ha_test2.png" alt="Cloudflared Denied" class="normal" width="400" height="300" data-proofer-ignore></p><blockquote><p>This should give you you client IP address via the x-forwarded-for header and not the IP address of the Cloudflared proxy (Check your IP address on https://ping.eu/)</p></blockquote></ol><h3 id="ip-ban-and-notification"><span class="mr-2">IP Ban and notification</span><a href="#ip-ban-and-notification" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li><p>Open a new browser tab and connect to your external hostname; for example https://ha.mydomain.com and use a wrong username and password for a minimum 5 times. This should give you a persistent notification in the notification center in the Home Assistant dashboard and a notification on your mobile or other device that you have configured.</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3C/svg%3E" data-src="/assets/img/Screenshot%20at%20Aug%2030_ha_test3.png" alt="Cloudflared Denied" class="normal" width="400" height="300" data-proofer-ignore></p><blockquote><p>This should give you your client IP address via the x-forwarded-for header and not the IP address of the Cloudflared proxy (Check your IP address on https://ping.eu/)</p></blockquote><p>This will create a new file ip_ban.yaml with the relevant IP address and time of the ban <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="/assets/img/Screenshot%20at%20Aug%2030_ha_test3b.png" alt="HA IP ban" class="normal" width="700" height="400" data-proofer-ignore></p><p>You can remove the complete entry restart Home Assistant to remove the ban</p></ol><p>### Deny access from the internet to the /local URI</p><ol><li>Open a new browser tab and connect to your external hostname; for example https://ha.mydomain.com/local</ol><p>You should receive Access Denied <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="/assets/img/Screenshot%20at%20Aug%2030_ha_test1.png" alt="Cloudflared Denied" width="700" height="400" data-proofer-ignore></p><p>Check the logs in Cloudflare -&gt; Security -&gt; Overview. You should see Action taken Block with the rule name and extra details <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="/assets/img/Screenshot%20at%20Aug%2030_ha_test4b.png" alt="Cloudflared Denied" width="700" height="400" data-proofer-ignore></p><h3 id="redirect-all-http-to-https"><span class="mr-2">Redirect all HTTP to HTTPS</span><a href="#redirect-all-http-to-https" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Open a new browser tab and try to connect to your external hostname with HTTP, for example, http://ha.mydomain.com. This should be redirected to HTTPS</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/smart-home/'>Smart Home</a>, <a href='/categories/home-assistant/'>Home Assistant</a>, <a href='/categories/cloudflare/'>Cloudflare</a>, <a href='/categories/remote-access/'>Remote Access</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/home-assistant/" class="post-tag no-text-decoration" >Home Assistant</a> <a href="/tags/smart-home/" class="post-tag no-text-decoration" >Smart Home</a> <a href="/tags/cloudflare-tunnel/" class="post-tag no-text-decoration" >Cloudflare Tunnel</a> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Home+Assistant+remote+access+with+CloudFlare+Tunnel+-+Tech+Notes&url=https%3A%2F%2Fkrisbogaerts.github.io%2Fposts%2FHomeAssistant-RemoteAccess-with-CloudflareTunnel%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Home+Assistant+remote+access+with+CloudFlare+Tunnel+-+Tech+Notes&u=https%3A%2F%2Fkrisbogaerts.github.io%2Fposts%2FHomeAssistant-RemoteAccess-with-CloudflareTunnel%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fkrisbogaerts.github.io%2Fposts%2FHomeAssistant-RemoteAccess-with-CloudflareTunnel%2F&text=Home+Assistant+remote+access+with+CloudFlare+Tunnel+-+Tech+Notes" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Open-Source-Collaborative-Security-with-CrowdSec-Part-1/">Open Source & Collaborative Security with CrowdSec Part 1</a><li><a href="/posts/How-to-run-Home-Assistant-HassOS-on-MacOS-M1-with-UTM/">How to run Home Assistant OS on MacOS M1 with UTM</a><li><a href="/posts/HomeAssistant-RemoteAccess-with-CloudflareTunnel/">Home Assistant remote access with CloudFlare Tunnel</a><li><a href="/posts/new-blog-with-jekyll-and-chirpy-theme/">New Github Pages blog with Jekyll and the Chirpy theme</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/arm64/">arm64</a> <a class="post-tag" href="/tags/home-assistant/">Home Assistant</a> <a class="post-tag" href="/tags/macbook-pro-m1/">Macbook Pro M1</a> <a class="post-tag" href="/tags/macos/">MacOS</a> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/cloudflare-tunnel/">Cloudflare Tunnel</a> <a class="post-tag" href="/tags/crowdsec/">crowdsec</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/endlessh/">endlessh</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/new-blog-with-jekyll-and-chirpy-theme/"><div class="card-body"> <em class="small" data-ts="1661637600" data-df="ll" > Aug 28, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>New Github Pages blog with Jekyll and the Chirpy theme</h3><div class="text-muted small"><p> Getting started installation Jekyll on MacOS This post is about the installation and setup of a new blog/documentation site on GitHub Pages with Jekyll and the Chirpy theme. Technical notes on the ...</p></div></div></a></div><div class="card"> <a href="/posts/How-to-run-Home-Assistant-HassOS-on-MacOS-M1-with-UTM/"><div class="card-body"> <em class="small" data-ts="1662760800" data-df="ll" > Sep 10, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to run Home Assistant OS on MacOS M1 with UTM</h3><div class="text-muted small"><p> Testing configuration/add-ons on my Home Assistant production instance comes with a risk. I always used the Home Assistant add-on development container with Visual Studio Code, but today I needed ...</p></div></div></a></div><div class="card"> <a href="/posts/Open-Source-Collaborative-Security-with-CrowdSec-Part-1/"><div class="card-body"> <em class="small" data-ts="1663106400" data-df="ll" > Sep 14, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Open Source & Collaborative Security with CrowdSec Part 1</h3><div class="text-muted small"><p> Intro CrowdSec is an open-source and collaborative IPS (Intrusion Prevention System). It leverages local behavior analysis to create a global IP reputation network. Analyze behaviors, respond to...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/new-blog-with-jekyll-and-chirpy-theme/" class="btn btn-outline-primary" prompt="Older"><p>New Github Pages blog with Jekyll and the Chirpy theme</p></a> <a href="/posts/How-to-run-Windows11-on-MacBook-Pro-M1-with-VMware-Fusion/" class="btn btn-outline-primary" prompt="Newer"><p>How to run Windows 11 on MacBook Pro M1 with VMware Fusion</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://krisbogaerts.github.io/posts/HomeAssistant-RemoteAccess-with-CloudflareTunnel/'; this.page.identifier = '/posts/HomeAssistant-RemoteAccess-with-CloudflareTunnel/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://krisbogaerts.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/BogaertsKris">Kris Bogaerts</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/arm64/">arm64</a> <a class="post-tag" href="/tags/home-assistant/">Home Assistant</a> <a class="post-tag" href="/tags/macbook-pro-m1/">Macbook Pro M1</a> <a class="post-tag" href="/tags/macos/">MacOS</a> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/cloudflare-tunnel/">Cloudflare Tunnel</a> <a class="post-tag" href="/tags/crowdsec/">crowdsec</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/endlessh/">endlessh</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-7PW1FQYYNS"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-7PW1FQYYNS'); }); </script>
